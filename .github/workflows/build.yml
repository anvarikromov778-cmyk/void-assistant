name: ðŸš€ Build Void Assistant APK

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¸Ð· Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð´Ð°
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    # 2. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Java
    - name: âš™ï¸ Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    # 3. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Android SDK
    - name: ðŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    # 4. ÐŸÑ€Ð¸Ð½ÑÑ‚Ð¸Ðµ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¹
    - name: ðŸ“ Accept Android licenses
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
    # 5. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
    - name: ðŸ“¦ Install Android components
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-34" \
          "build-tools;34.0.0" \
          "cmdline-tools;latest"
          
    # 6. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Gradle Wrapper ÐµÑÐ»Ð¸ Ð½ÐµÑ‚
    - name: ðŸ› ï¸ Create Gradle Wrapper
      run: |
        if [ ! -f "gradlew" ]; then
          echo "Creating Gradle wrapper..."
          # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ gradlew
          curl -L https://raw.githubusercontent.com/gradle/gradle/master/gradlew -o gradlew
          chmod +x gradlew
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ wrapper ÑÐ²Ð¾Ð¹ÑÑ‚Ð²Ð°
          mkdir -p gradle/wrapper
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
        fi
        
    # 7. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ÐµÑÐ»Ð¸ Ð½ÐµÑ‚
    - name: ðŸ“ Create project structure
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
        if [ ! -f "build.gradle" ]; then
          echo "Creating build.gradle..."
          cat > build.gradle << 'EOF'
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.1.3'
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          
          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          EOF
        fi
        
        if [ ! -f "settings.gradle" ]; then
          echo "Creating settings.gradle..."
          cat > settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          
          rootProject.name = "VoidAssistant"
          include ':app'
          EOF
        fi
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ app ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚
        if [ ! -d "app" ]; then
          echo "Creating app structure..."
          mkdir -p app/src/main/{java/com/void/assistant,res/{layout,values},assets}
          
          # app/build.gradle
          cat > app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
          }
          
          android {
              namespace 'com.void.assistant'
              compileSdk 34
              
              defaultConfig {
                  applicationId "com.void.assistant"
                  minSdk 21
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              
              buildTypes {
                  release {
                      minifyEnabled false
                  }
                  debug {
                      debuggable true
                  }
              }
          }
          
          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
          }
          EOF
          
          # ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ AndroidManifest.xml
          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application
                  android:allowBackup="true"
                  android:label="Void Assistant">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          
          # ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ MainActivity
          cat > app/src/main/java/com/void/assistant/MainActivity.java << 'EOF'
          package com.void.assistant;
          
          import androidx.appcompat.app.AppCompatActivity;
          import android.os.Bundle;
          
          public class MainActivity extends AppCompatActivity {
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
              }
          }
          EOF
          
          # ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ layout
          cat > app/src/main/res/layout/activity_main.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:gravity="center"
              android:orientation="vertical">
              
              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="Void Assistant"
                  android:textSize="24sp" />
                  
          </LinearLayout>
          EOF
          
          # Strings
          cat > app/src/main/res/values/strings.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">Void Assistant</string>
          </resources>
          EOF
        fi
        
    # 8. Ð¡Ð±Ð¾Ñ€ÐºÐ° APK
    - name: ðŸ”¨ Build APK
      run: |
        # Ð”Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° gradlew
        chmod +x ./gradlew || true
        
        # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… ÑÐ±Ð¾Ñ€Ð¾Ðº
        ./gradlew clean || echo "Clean failed, continuing..."
        
        # Ð¡Ð±Ð¾Ñ€ÐºÐ° debug APK
        ./gradlew assembleDebug --no-daemon --stacktrace
        
    # 9. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° APK
    - name: ðŸ” Find APK files
      run: |
        echo "ðŸ“± Searching for APK files..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
        mkdir -p artifacts
        
        # Ð˜Ñ‰ÐµÐ¼ APK Ñ„Ð°Ð¹Ð»Ñ‹
        find . -name "*.apk" -type f 2>/dev/null | head -5
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ APK
        APK_FOUND=false
        for apk in $(find . -name "*.apk" -type f 2>/dev/null); do
          echo "Found APK: $apk"
          cp "$apk" artifacts/
          APK_FOUND=true
        done
        
        if [ "$APK_FOUND" = false ]; then
          echo "âš ï¸ No APK files found, listing build directory..."
          ls -la app/build/outputs/apk/ 2>/dev/null || echo "No apk directory"
          ls -la app/build/ 2>/dev/null || echo "No build directory"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ Ñ‡Ñ‚Ð¾Ð±Ñ‹ workflow Ð½Ðµ Ð¿Ð°Ð´Ð°Ð»
          echo "Creating placeholder APK for debugging..."
          echo "APK_NOT_FOUND - Check build logs" > artifacts/ERROR_NO_APK.txt
        fi
        
        echo "ðŸ“¦ APK files in artifacts folder:"
        ls -la artifacts/
        
    # 10. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° APK Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°
    - name: ðŸ“¤ Upload APK artifact
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: void-assistant-apk
        path: artifacts/
        retention-days: 7
        
    # 11. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð»Ð¾Ð³Ð¾Ð² Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÐµÑÑ‚ÑŒ
    - name: ðŸ“Š Upload build logs
      if: always()
      run: |
        echo "Checking for build logs..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
        mkdir -p build-logs
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð»Ð¾Ð³Ð¸ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚
        if [ -d "app/build/reports" ]; then
          echo "Copying reports..."
          cp -r app/build/reports/* build-logs/ 2>/dev/null || true
        fi
        
        if [ -d "app/build/outputs/logs" ]; then
          echo "Copying output logs..."
          cp -r app/build/outputs/logs/* build-logs/ 2>/dev/null || true
        fi
        
        # Ð˜Ñ‰ÐµÐ¼ Ð»ÑŽÐ±Ñ‹Ðµ Ð»Ð¾Ð³Ð¸
        find . -name "*.log" -type f 2>/dev/null | head -10 | while read log; do
          echo "Found log: $log"
          cp "$log" build-logs/ 2>/dev/null || true
        done
        
        # Ð•ÑÐ»Ð¸ Ð»Ð¾Ð³Ð¾Ð² Ð½ÐµÑ‚, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ñ„Ð°Ð¹Ð»
        if [ ! "$(ls -A build-logs 2>/dev/null)" ]; then
          echo "No logs found, creating placeholder..."
          echo "No build logs available" > build-logs/NO_LOGS_FOUND.txt
        fi
        
        echo "Logs in build-logs:"
        ls -la build-logs/ 2>/dev/null || echo "No logs folder"
        
    # 12. Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ð°Ð¿ÐºÐ¸ Ñ Ð»Ð¾Ð³Ð°Ð¼Ð¸
    - name: ðŸ“¤ Upload logs artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build-logs/
        retention-days: 30
        if-no-files-found: warn  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½ÐµÑ‚
        
    # 13. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ summary
    - name: ðŸ“ Create build summary
      if: always()
      run: |
        echo "## ðŸš€ Build Result" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… **Build Successful**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Build Failed**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± APK Files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ APK Ð² artifacts
        if [ -d "artifacts" ]; then
          for file in artifacts/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(stat -c%s "$file" 2>/dev/null || echo "unknown")
              echo "- **$filename** ($((size/1024)) KB)" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "No APK files found in artifacts" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. Download APK from Artifacts section" >> $GITHUB_STEP_SUMMARY
        echo "2. Install on Android device" >> $GITHUB_STEP_SUMMARY
        echo "3. Enable 'Install from unknown sources' in settings" >> $GITHUB_STEP_SUMMARY
